<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xml:lang="en">
<head>
  <title>Calculator</title>
  <link href="https://fonts.googleapis.com/css?family=Abril+Fatface|Open+Sans|Rubik+One" rel="stylesheet">
  <style>
  body,
div {
	padding:0;
	margin:0;
}

body,
div {
	display: flex;
	flex-flow: row wrap;
	justify-content: space-around;
	align-content: stretch;
}
/* Calculator */

#calculator {
	top: 20px;
	width: 300px;
	height: 442px;
	flex: 0 1 auto;
	align-self: center;
	justify-content: space-around;
	display: flex;
	flex-flow: row wrap;
	box-shadow: 0px 0px 30px 5px rgba(0,0,0,0.75);
	-webkit-box-shadow: 0px 0px 30px 5px rgba(0,0,0,0.75);
	-moz-box-shadow: 0px 0px 30px 5px rgba(0,0,0,0.75);
	-webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Chrome/Safari/Opera */
    -khtml-user-select: none; /* Konqueror */
    -moz-user-select: none; /* Firefox */
    -ms-user-select: none; /* Internet Explorer/Edge */
    user-select: none; /* Non-prefixed version, currently not supported by any browser */
	/*TODO not pretty*/
}

#total {
	height: 77px;
	width: 100%;
	margin: auto;
	background-color: black;
	display: flex;
	flex-flow: row wrap;
	color:white;
}

#display {
	float: left;
	width: 225px;
	height: 77px;
	text-align: right;
	display: flex;
	flex-flow: column nowrap;
	justify-content: center;
	align-items: flex-end;
}

#screen {
	flex-basis: 45px;
	font-size: 26px;
	margin-top: 20px;
}

#result {
	flex-basis: 20px;
}

#clear {
	float: right;
	height: 78px;
}

#keyboard {
	height: 375px;
	width: 300px;
	background-color: green;
	text-align: right;
}

.key {
	display: inline;
	height: 75px;
	width: 75px;
	border: 1px solid #D6D7D7;
	background-color: light-grey;
	float: left;
	text-align: center;
	cursor: pointer;
	font-size: 40px;
}

#equals {
	width: 148px;
	background-color: orange;
}

#nroot {
	display: inline;
	font-size: 30px;
	top: -5px;

}

.clears {
	background-color: darkgrey;
}

.operators {
	background-color: orange;
}

/* Calculator On Hover Effects */

button:hover,
button.hover{
	background-color: lightgrey;
}

#equals:hover,
#equals.hover{
	background-color: royalblue;
}

.operators:hover,
.operators.hover{
	background-color: lightskyblue;
}

.clears:hover,
.clears.hover{
	background-color: salmon;
}

  </style>
</head>
<meta http-equiv="Content-Type" content="text/xhtml; charset=UTF-8" />
<body>
	<main id="calculator">
    <div id="total">
      <div id="display" role="main" aria-live="assertive">
        <div id="screen"></div>
        <div id="result"></div>
      </div>
      <button aria-label="backspace" class="key clears" id="clear">&lt;</button>
    </div>
    <div id="keyboard">
      <button aria-label="clear all" class="key clears" id="clearall">AC</button>
      <button class="key operators" id="percent">%</button>
      <button aria-label="nth root" class="key operators" id="nroot">√</button>
      <button class="key operators">+</button>
      <button class="key">7</button>
      <button class="key">8</button>
      <button class="key">9</button>
      <button aria-label="minus" class="key operators">-</button>
      <button class="key">4</button>
      <button class="key">5</button>
      <button class="key">6</button>
      <button class="key operators">&divide;</button>
      <button class="key">1</button>
      <button class="key">2</button>
      <button class="key">3</button>
      <button class="key operators">&times;</button>
      <button class="key">0</button>
      <button aria-label="decimal point" class="key" id="decimal">.</button>
      <button class="key operators" id="equals">=</button>
    </div>
  </main>
  <script>
	// Menu
function toggleSlide(target, x) { // eslint-disable-line no-unused-vars
  var el = document.getElementById(x);
  el.classList.toggle('hide');
  if (target.getAttribute('aria-expanded') === true)
    target.setAttribute('aria-expanded', false);
  else
    target.setAttribute('aria-expanded', true);
}

// Calculator

// Keys and Operators
var keys = document.querySelectorAll('.key');
// Following code is not the most elegant, but allows future expansion of keys
var operators = [].slice.call(document.querySelectorAll('.operators'))
  .map(tagValues);
var maxLength = 17;

// Helper function for mapping of dom elements values
function tagValues(element) {
  return element.innerHTML;
}

// Variables used for calculation
var screen = document.querySelector('#screen');
var result = document.querySelector('#result');
var decimal = false; // Only on point per number allowed
var expression = ''; // Evaluated on 'operators' or 'equals'
var ready = true; // Identify when calculator is ready for the next expression
var equated = false; // Detect that equals is pressed
screen.innerHTML = '0';

// Mouse events

// Assigning onlick for each keys
for (var i = 0; i < keys.length; i++)
  keys[i].onclick = clicker;

// Handling any mouse click
function clicker(e) {
  calculations(this.innerHTML);
}

// Key identifiers
var wkDic = {
  65: 'AC',
  8: '&lt;',
  190: '.',
  189: '-',
  187: '=',
  13: '=',
  32: '=',
  191: '\u00F7',
  78: '√'
};

var mozDic = {
  65: 'AC',
  8: '&lt;',
  190: '.',
  173: '-',
  61: '=',
  13: '=',
  32: '=',
  191: '\u00F7',
  78: '√'
};
// Key identifiers in combination with SHIFT
var wkCombos = {53: '%', 56: '\u00D7', 187: '+'};
var mozCombos = {53: '%', 56: '\u00D7', 61: '+'};

// Detecting browser an assgning correct key codes
var firefox = typeof InstallTrigger !== 'undefined';
var dictionary = firefox ? mozDic : wkDic;
var combos = firefox ? mozCombos : wkCombos;

// Key events
document.addEventListener('keydown', function(event) {
  if (event.defaultPrevented) {
    // Avoid event duplication
    return;
  }

  if (event.shiftKey && combos.hasOwnProperty(event.which)) {
    calculations(combos[event.which]);
    hover(combos[event.which]);
  } else {
    if (dictionary.hasOwnProperty(event.which)) {
      calculations(dictionary[event.which]);
      hover(dictionary[event.which]);
    } else if (!event.shiftKey && event.which > 47 && event.which < 58) {
      calculations(String(parseInt(event.which) - 48));
      hover(String(parseInt(event.which) - 48));
    }
  }
}, true);

function hover(key) {
  for (var i = 0; i < keys.length; i++) {
    if (keys[i].innerHTML === key) {
      keys[i].classList.toggle('hover');
      unhover(i);
    }
  }
}

function unhover(i) {
  window.setTimeout(function() {
    keys[i].classList.toggle('hover');
  }, 500);
}
// Calculations

function calculations(pressed) {
  if (!pressed)
    return false;

  if (expression === 'Infinity')
    insert('', 0, false);

  var last = expression.slice(-1);

  // Check if clears are pressed
  if (pressed === 'AC') {
    insert('', '0', false);
    ready = true;
  } else if (pressed === '&lt;') {
    // Check if deleted symbol is decimal point
    if (screen.innerHTML.slice(-1) === '.')
      decimal = false;
    var s = screen.innerHTML.length > 1 ? screen.innerHTML.slice(0, -1) : '0';
    insert(expression.slice(0, -1), s, decimal);
  } else if (operators.indexOf(pressed) > -1) {
    operations(pressed, last);
  } else if (pressed === '.') {
    // Decimal point
    if (!decimal && !equated) {
      if (expression === '' || expression === '0') {
        insert('0.', '0.', true);
      } else if (operators.indexOf(last) > -1 && expression.indexOf('.') < 0) {
        var shortened = expression.replace(last, '.');
        insert(shortened, shortened, true);
      } else if (ready) {
        add('0.', true, true);
      } else {
        add(pressed, true, true);
      }
      ready = false;
    }
  } else if (!(pressed === '0' && expression === '0')) {
    if (equated) {
      insert(pressed, pressed, decimal);
      equated = false;
    } else if ((screen.innerHTML === '0' && expression === '0') ||
               (screen.innerHTML === '0' && expression === '')) {
      insert(pressed, pressed, decimal);
    } else if (screen.innerHTML.length < maxLength) { // Maximum length
      add(pressed, true, decimal);
    }
    ready = false;
  }
}

// Operators helper function
function operations(pressed, last) {
  // Directly return result of the last expression
  var reg = /^(-?\d+(?:\.\d+)?)([^.0-9])(\d+(?:\.\d+)?)$/;
  var equation;
  if (expression.match(reg)) {
    var groups = reg.exec(expression);
    var num1 = parseFloat(groups[1]);
    var num2 = parseFloat(groups[3]);
    var res;

    if (groups[2] === '√') {
      equation = Math.pow(num1, 1 / num2);
    } else {
      equation = expression.replace('÷', '/')
       .replace('\u00F7', '/').replace('\u00D7', '*');
    }
    if (pressed === '%') {
      var calculated = percentage(num2, num1);
      equation.replace(new RegExp(num2 + '$'), calculated);
      pressed = '';
    }
    var finalResult = eval(equation).toString(); // eslint-disable-line no-eval
    if (!isNaN(finalResult))
      insert(finalResult, finalResult, false);
  } else if (pressed === '%') {
    // absolute percentage
    res = percentage(parseFloat(expression, 2), false).toString();
    insert(res, res, false);
    pressed = '';
  }
  // Replace last operator if necessary
  if (operators.indexOf(last) > -1 || last === '.')
    expression = expression.slice(0, -1);

  if (screen.innerHTML === '0' && expression === '' && pressed === '-') {
    insert(pressed, pressed, false);
  } else if (screen.innerHTML === 'Infinity') {
    insert('', '0', false);
  } else if (pressed !== '=' && !ready) {
    console.log('mehere');
    insert(expression + pressed, '0', false);
    equated = false;
  } else if (pressed === '=') {
    if (last === '×' || last === '\u00D7') {
      var num = parseFloat(expression, 5);
      res = (num * num).toString();
      insert(res, res, false);
    }
    equated = true;
  } else if (ready && expression !== '') {
    console.log('me');
    add(pressed, false, decimal);
    equated = false;
  }
  ready = true;
}

// Helpers
function percentage(num1, num2) {
  return num2 ? (num1 * num2 / 100) : (num1 / 100);
}

// Insert or add to screen
function add(key, current, decValue) {
  // Allow calculations with result of previous calculations
  if (current)
    screen.innerHTML = ready ? key : (screen.innerHTML + key);

  expression += key;
  result.innerHTML = expression;
  decimal = decValue;
}

function insert(forExpr, forScreen, decValue) {
  screen.innerHTML = forScreen.length <= maxLength ? forScreen : '0';
  expression = forExpr;

  result.innerHTML = expression;
  decimal = decValue;
}
</script>
</body>
</html>
